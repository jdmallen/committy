#!/bin/bash

# Committy AI-powered commit message hook
# Generated by install-git-hook.sh
# Created by Jesse Mallen with help from Venkat Sunkara and Adewale Adegbola, 2025

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"
SHA1="$3"

# Only run for regular commits (not merges, rebases, squashes, etc.)
if [ -n "$COMMIT_SOURCE" ]; then
    exit 0
fi

# Check if committy is available
if ! command -v committy >/dev/null 2>&1; then
    echo "# Committy not found in PATH - skipping AI commit message generation" >> "$COMMIT_MSG_FILE"
    exit 0
fi

# Check if we have staged changes
if git diff --cached --quiet; then
    exit 0
fi

# Check for Azure OpenAI configuration
if [ -z "$AZURE_OPENAI_API_KEY" ] || [ -z "$AZURE_OPENAI_ENDPOINT_HOST" ] || [ -z "$AZURE_OPENAI_DEPLOYMENT" ]; then
    echo "# Azure OpenAI configuration incomplete - skipping AI commit message generation" >> "$COMMIT_MSG_FILE"
    echo "# Required: AZURE_OPENAI_API_KEY, AZURE_OPENAI_ENDPOINT_HOST, AZURE_OPENAI_DEPLOYMENT" >> "$COMMIT_MSG_FILE"
    exit 0
fi

# Generate AI commit message suggestions
echo "# Generating AI commit message suggestions..." >> "$COMMIT_MSG_FILE"
echo "#" >> "$COMMIT_MSG_FILE"

# Get suggestions and format them as comments
if SUGGESTIONS=$(git diff --cached | committy --no-git 2>/dev/null); then
    echo "# AI-generated suggestions (uncomment and edit as needed):" >> "$COMMIT_MSG_FILE"
    echo "#" >> "$COMMIT_MSG_FILE"

    # Remove trailing newline from suggestions
    SUGGESTIONS=$(printf '%s' "$SUGGESTIONS")
    
    # Add suggestions as commented lines at the top, before any existing content
    {
        echo ""
        echo ""
        echo "# Please enter the commit message for your changes. Lines starting"
        echo "# with '#' will be ignored, and an empty message aborts the commit."
        echo "#"
        echo "# Suggested commit messages:"
        echo "$SUGGESTIONS" | sed 's/^/#   /'
        echo "#"
        tail -n +5 "$COMMIT_MSG_FILE"
    } > "$COMMIT_MSG_FILE.tmp"
    mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"

    echo "#" >> "$COMMIT_MSG_FILE"
    echo "# Or write your own commit message above" >> "$COMMIT_MSG_FILE"
else
    echo "# Failed to generate AI suggestions" >> "$COMMIT_MSG_FILE"
fi

echo "" >> "$COMMIT_MSG_FILE"
